<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>üìã –ó–∞–¥–∞—á–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-button@4.6.4/dist/index.min.js"></script> <!-- [web:51][web:67] -->
    <style>
        :root { color-scheme: light dark; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: var(--tg-theme-bg-color, #111);
            color: var(--tg-theme-text-color, #fff);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            padding: 12px 16px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        #tasks {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px 80px;
        }
        .task {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #222);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .task-status {
            cursor: pointer;
            user-select: none;
            margin-top: 2px;
        }
        .task-text {
            flex: 1;
            cursor: pointer;
        }
        .subtasks {
            margin-top: 6px;
            font-size: 13px;
        }
        .subtask {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 2px;
        }

        .input-bar {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 0);
            left: 0;
            right: 0;
            padding: 6px 8px;
            background: var(--tg-theme-bg-color, #111);
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .emoji-btn, .send-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }
        .send-btn {
            background: var(--tg-theme-button-color, #2ea6ff);
            color: var(--tg-theme-button-text-color, #fff);
            font-size: 18px;
        }
        .msg-input {
            flex: 1;
            border-radius: 18px;
            border: none;
            padding: 6px 10px;
            font-size: 14px;
            outline: none;
            background: var(--tg-theme-secondary-bg-color, #222);
            color: inherit;
        }
    </style>
</head>
<body>
<header>üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏</header>

<div id="tasks"></div>

<div class="input-bar">
    <button class="emoji-btn" id="emojiTrigger">üòä</button>
    <input id="taskInput" class="msg-input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." />
    <button class="send-btn" id="addBtn">‚ûï</button>
</div>

<script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand(); // [web:34]

    // ===== –î–ê–ù–ù–´–ï =====
    let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');

    function saveTasks() {
        localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function renderSubtasks(task, taskIndex) {
        if (!task.subtasks || !task.subtasks.length) return '';
        return `
          <div class="subtasks">
            ${task.subtasks.map((s, j) => `
              <div class="subtask" onclick="toggleSubtask(${taskIndex}, ${j}); event.stopPropagation();">
                <span>${s.done ? '‚òëÔ∏è' : '‚¨ú'}</span>
                <span>${s.text}</span>
              </div>
            `).join('')}
          </div>
        `;
    }

    function renderTasks() {
        const box = document.getElementById('tasks');
        box.innerHTML = tasks.map((t, i) => `
          <div class="task">
            <div class="task-status" onclick="toggleTask(${i})">
              ${t.done ? '‚úÖ' : 'üî¥'}
            </div>
            <div class="task-text" onclick="openTaskMenu(${i})">
              ${t.text}
              ${renderSubtasks(t, i)}
            </div>
          </div>
        `).join('');
    }

    window.toggleTask = function(index) {
        tasks[index].done = !tasks[index].done;
        saveTasks();
        renderTasks();
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    };

    window.toggleSubtask = function(taskIndex, subIndex) {
        const s = tasks[taskIndex].subtasks[subIndex];
        s.done = !s.done;
        saveTasks();
        renderTasks();
        Telegram.WebApp.HapticFeedback.impactOccurred('light');
    };

    window.openTaskMenu = function(index) {
        const choice = prompt(
            '–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:\n' +
            '1 ‚Äì –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É\n' +
            '2 ‚Äì –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É\n' +
            '3 ‚Äì –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É'
        );
        if (choice === '1') editTask(index);
        else if (choice === '2') addSubtask(index);
        else if (choice === '3') deleteTask(index);
    };

    function editTask(index) {
        const cur = tasks[index].text;
        const text = prompt('–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏:', cur);
        if (text && text.trim()) {
            tasks[index].text = text.trim();
            saveTasks(); renderTasks();
        }
    }

    function addSubtask(index) {
        const text = prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–∑–∞–¥–∞—á–∏:');
        if (!text || !text.trim()) return;
        if (!tasks[index].subtasks) tasks[index].subtasks = [];
        tasks[index].subtasks.push({ text: text.trim(), done: false });
        saveTasks(); renderTasks();
    }

    function deleteTask(index) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
        tasks.splice(index, 1);
        saveTasks(); renderTasks();
    }

    // ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ô –ó–ê–î–ê–ß–ò =====
    function addTaskFromInput() {
        const input = document.getElementById('taskInput');
        const text = input.value.trim();
        if (!text) return;
        tasks.push({ text, done: false, subtasks: [] });
        saveTasks();
        renderTasks();
        input.value = '';
        Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }

    document.getElementById('addBtn').onclick = addTaskFromInput;
    document.getElementById('taskInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') addTaskFromInput();
    });

    // ===== EMOJI PICKER =====
    const trigger = document.getElementById('emojiTrigger');
    const input = document.getElementById('taskInput');

    const picker = new EmojiButton({
        position: 'top-start',
        theme: Telegram.WebApp.colorScheme === 'dark' ? 'dark' : 'light',
        autoHide: true
    }); // [web:51][web:67]

    trigger.addEventListener('click', () => {
        picker.togglePicker(trigger);
    });

    picker.on('emoji', emoji => {
        input.value += emoji;
        input.focus();
    });

    Telegram.WebApp.MainButton
        .setText('üîÑ –û–±–Ω–æ–≤–∏—Ç—å')
        .show()
        .onClick(renderTasks);

    renderTasks();
</script>
</body>
</html>
